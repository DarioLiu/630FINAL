<!DOCTYPE html>
<html>

<head>
    

    <script src="./js/d3.v7.min.js"></script>
    <script src="./js/util.js"></script>
    <link rel="stylesheet" href="./style.css">
</head>
<body>
    <div class="heading">
        <h1>The Vaccination Progress Map Around World</h1>
    </div>
    <body>
        <div id="presentation">
            <div id="mapbox">
                <div id="compo" > 
                    <div id="compo-year">
                        <div id="label">Select Year: </div>
                        <select id="select-year"></select>
                    </div>
            
                    <div id="compo-vac">
                        <div id="label">Select Vaccine: </div>
                        <select id="select-vac"></select>
                    </div>
            
                    <div id="compo-month">
                        <div id="label"> Select Month: </div>
                        <input id="select-month" type="range" min="1" max="13" value="1"/>
                        <output id="show-month" for="select-month">1</output>
                    </div>
                </div>
            
                <div id="colorscale">
                    <span></span>
                    <span id="color1">Test</span>
                    <span id="color2">Test2</span>
                    <span id="color3">Color 3</span>
                    <span id="color4">Test4</span>
                    <span></span>
                </div>
            
                <svg id="svg-container">      
            
                </svg>
            </div>
            <div id="description">
                <h2>The Fact about Covid Vaccine Progress</h2>
            </div>
        </div>

    <script>
        config = {
            svgWidth: 648,
            svgHeight: 680,
            figLeftMargin: 0,
            
            figTopMargin: 20,
            earthWidth: 650,
            earthHeight: 650,
        };

        svgContainer = d3.select("#svg-container")
            .attr("width", config.svgWidth)
            .attr("height", config.svgHeight);
        
        // 
        let selectVacs = d3.select("#select-vac");
        let selectYear = d3.select("#select-year");
        let selectMonth = d3.select("#select-month");

        let maxYear;
        let showMonth = d3.select("#show-month");
        let showYear = d3.select("#show-year");

        ////////////////
        let allYearData; // 所有年份的数据
        let locationToSum; // 某年某月下各地区-疫苗接种总数

        let countryFigSels;

        let vacTypeToColor = d3.scaleOrdinal()
            .range(d3.schemeSet3);
      
        function updateContryFig(){
            let vacType = selectVacs.node().value;

            let vacColor = vacTypeToColor(vacType)
            
            let numberToColor =  makeNumberToColor(locationToSum, vacColor);
            
            countryFigSels /// For loop color change based on the number change
            .attr("fill", d => {
                console.log(numberToColor(locationToSum[d._fig_location]))
                return numberToColor(locationToSum[d._fig_location])})
            let colorRange = [];
            let color = d3.color(vacColor);
            
            
               

                document.getElementById("color1").style.backgroundColor = color;
                document.getElementById("color2").style.backgroundColor = color.darker(1);
                document.getElementById("color3").style.backgroundColor= color.darker(2);
                document.getElementById("color4").style.backgroundColor= color.darker(3);
        
        }


        function updateSelectedData()
        {
            const yearValue = selectYear.node().value;
            const vacValue = selectVacs.node().value;
            const monthValue = selectMonth.node().value;

            showMonth.text(monthValue);
            showYear.text(yearValue);

            let filterYear;
            if(yearValue === 'Years'){
                filterYear = (e)=>true;
            } // 所有年份 == Years
            else
            {
                filterYear = e => e['date'].slice(0, 4) === yearValue;
            }

            let filterMonth;
            if(+monthValue === 13){
                filterMonth = (e)=>true;
                showMonth.text("AllYears") 
            } // 全年 == AllYears
            else
            {
                filterMonth = row => +row['date'].slice(5, 7) === +monthValue;
            }

            let filterVacType;
            if(vacValue === 'AllVac'){
                filterVacType = (e) => true
            } // 所有疫苗 == AllVac
            else
            {
                filterVacType = row => row["vaccine"] === vacValue;
            }

            let selectedData = allYearData.filter(row => 
                filterYear(row) && filterMonth(row) && filterVacType(row)
            );

            locationToSum = calcLocationToData(selectedData);
        }

        [selectYear, selectVacs, selectMonth]
        .forEach(e=>e.on("change", ()=>{
            updateSelectedData();
            updateContryFig();
        }))
        
        d3.json("./data/data_set.json")
        .then(data => {
            allYearData = data;

            let vacType = new Set(['AllVac', ...data.map(e => e["vaccine"])]); //所有疫苗 = AllVac
            appendOptionToSelect(selectVacs, vacType);
            vacTypeToColor.domain(vacType);

            let allYears = new Set(data.map(e => +e["date"].slice(0, 4)));
            allYears.add("Years") // 所有年份 == Years
            appendOptionToSelect(selectYear, allYears)

            d3.json("./data/GeoChart.world.geo.json")
                .then(mapData => {
                    const projection = d3.geoOrthographic()
                        .fitExtent([[0, 0], [config.earthWidth, config.earthHeight]], mapData)
                        .rotate([0, 0, 0])
                        .scale(300)

                    const geoGenerator = d3.geoPath()
                        .projection(projection);

                    svgContainer.append("g")
                        .attr('transform', `translate(${config.figLeftMargin}, ${config.figTopMargin})`)

                    countryFigSels = svgContainer
                        .append("g")
                        .attr('transform', `translate(${config.figLeftMargin}, ${config.figTopMargin})`)
                        .selectAll("NONE")
                        .data(mapData.features)
                        .enter()
                        .append("path")
                        .each(d => {
                            d['_fig_location'] = d['properties']['sovereignt'];
                            d['_fig_center'] = [d['properties']['label_x'], d['properties']['label_y']];
                        })
                        .attr("d", p => geoGenerator(p));

                    countryFigSels
                    .call(makeHover(location => locationToSum[location]));

                    svgContainer
                    .call(makeRotate(projection, geoGenerator, countryFigSels));

                    updateSelectedData()
                    updateContryFig()
                })

            })
    </script>
   

</body>

</html>